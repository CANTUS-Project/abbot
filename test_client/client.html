<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Test Client for Abbott (the Cantus API Server)</title>
        <script src="jquery-2.1.4.js"></script>
        <style>
            .emboxed { border: 1px solid silver; background-color: ghostwhite; }
            .pre { font-family: monospace; }
            ul.no-bullets li { list-style-type: none; }

            /* the box that contains the following two things */
            .request-box { overflow: hidden; clear: both; }

            /* for the request currently being prepared */
            .div-request-input { width: 50%; float:left; }
            .div-request-input ul { padding: 0; }

            /* for the previously-submitted request */
            .div-request-display { width: 50%; float:right; }
            .div-request-display ul { padding: 0; }
            /* ---------------------------------------------------------------------------------- */
            /* CRA: I got this trick from JSFiddle: https://jsfiddle.net/unLSJ/                   */
            pre.output {
                background-color: ghostwhite;
                border: 1px solid silver;
                padding: 10px 20px;
                margin: 20px;
            }
            .json-key { color: brown; }
            .json-value { color: navy; }
            .json-string { color: olive; }
            /* end of content from JSFiddle                                                       */
            /* ---------------------------------------------------------------------------------- */
        </style>
    </head>

    <body>
        <h1>Test Client for Abbott (the Cantus API Server)</h1>

        <h2>Request</h2>

        <div class="request-box">
            <div class="div-request-input">
            <ul class="no-bullets">
                <li>URL: <span class="pre" id="input-request-url"></span></li>
                <li>Action: <select id="input-action">
                                <option value="browse">Browse</option>
                                <option value="search">Search</option>
                                <option value="view">View</option>
                            </select></li>
                <li>Resource Type: <select id="input-type">
                                       <option value="cantusids">Cantus ID</option>
                                       <option value="centuries">Century</option>
                                       <option value="chants">Chant</option>
                                       <option value="feasts">Feast</option>
                                       <option value="genres">Genre</option>
                                       <option value="indexers">Indexer</option>
                                       <option value="notations">Notation</option>
                                       <option value="offices">Office</option>
                                       <option value="portfolia">Portfolio</option>
                                       <option value="provenances">Provenance</option>
                                       <option value="sigla">Siglum</option>
                                       <option value="segments">Segment</option>
                                       <option value="sources">Source</option>
                                   </select></li>
                <li>ID: <input type="text" id="input-id" disabled="true"/></li>
                <li>X-Cantus-Per-Page: <input type="number" id="input-per-page"/></li>
                <li>X-Cantus-Page: <input type="number" id="input-page"/></li>
                <li>X-Cantus-Include-Resources: <input type="checkbox" id="input-include-resources"/></li>
                <li>X-Cantus-Sort: <input type="text" id="input-sort"/></li>
                <li>X-Cantus-No-Xref: <input type="checkbox" id="input-no-xref"/></li>
                <li>X-Cantus-Fields: <input type="text" id="input-fields"/></li>
                <li>X-Cantus-Search-Help: <input type="text" id="input-search-help" value="not implemented" disabled="true"/></li>
            </ul>
            <label for="input-request-body">Request Body:<br/></label>
            <textarea id="input-request-body" autocomplete="off" cols="100" rows="10" wrap="soft"></textarea>
            </div>

            <div class="div-request-display">
            <ul class="no-bullets">
                <!-- <li>?: <span class="pre" id="?"></span></li> -->
                <li>URL: <span class="pre" id="display-server-url"></span></li>
                <li>X-Cantus-Per-Page: <span class="pre" id="display-per-page"></span></li>
                <li>X-Cantus-Page: <span class="pre" id="display-page"></span></li>
                <li>X-Cantus-Include-Resources: <span class="pre" id="display-include-resources"></span></li>
                <li>X-Cantus-Sort: <span class="pre" id="display-sort"></span></li>
                <li>X-Cantus-No-Xref: <span class="pre" id="display-no-xref"></span></li>
                <li>X-Cantus-Fields: <span class="pre" id="display-fields"></span></li>
                <li>X-Cantus-Search-Help: <span class="pre" id="display-search-help">not implemented</span></li>
            </ul>
            <label for="display-request-body">Request Body:<br/></label>
            <p id="display-request-body" class="pre emboxed"></p>
            </div>
        </div>

        <p>
            <button id="btn-submit">Submit Request</button>
        </p>

        <h2>Response</h2>
        <ul class="response-values no-bullets">
            <!-- <li>?: <span class="pre" id="?"></span></li> -->
            <li>Status: <span class="pre" id="response-status"></span></li>
            <li>Server: <span class="pre" id="response-server"></span></li>
            <li>X-Cantus-Version: <span class="pre" id="response-cantus-version"></span></li>
            <li>X-Cantus-Per-Page: <span class="pre" id="response-per-page"></span></li>
            <li>X-Cantus-Page: <span class="pre" id="response-page"></span></li>
            <li>X-Cantus-Include-Resources: <span class="pre" id="response-include-resources"></span></li>
            <li>X-Cantus-Sort: <span class="pre" id="response-sort"></span></li>
            <li>X-Cantus-No-Xref: <span class="pre" id="response-no-xref"></span></li>
            <li>X-Cantus-Fields: <span class="pre" id="response-fields"></span></li>
            <li>X-Cantus-Total-Results: <span class="pre" id="response-total-results"></span></li>
            <li>X-Cantus-Search-Help: <span class="pre" id="response-search-help">not implemented</span></li>
        </ul>

        <pre class="output"><code id="output"></code></pre>

        <script>
            // ---------------------------------------------------------------------------------- //
            // CRA: I got this trick from JSFiddle: https://jsfiddle.net/unLSJ/
            if (!library) { var library = {}; }

            library.json = {
                replacer: function(match, pIndent, pKey, pVal, pEnd) {
                    var key = '<span class=json-key>';
                    var val = '<span class=json-value>';
                    var str = '<span class=json-string>';
                    var r = pIndent || '';
                    if (pKey)
                        r = r + key + pKey.replace(/[": ]/g, '') + '</span>: ';
                    if (pVal)
                        r = r + (pVal[0] == '"' ? str : val) + pVal + '</span>';
                    return r + (pEnd || '');
                    },
                prettyPrint: function(obj) {
                    var jsonLine = /^( *)("[\w]+": )?("[^"]*"|[\w.+-]*)?([,[{])?$/mg;
                    return JSON.stringify(obj, null, 3)
                        .replace(/&/g, '&amp;').replace(/\\"/g, '&quot;')
                        .replace(/</g, '&lt;').replace(/>/g, '&gt;')
                        .replace(jsonLine, library.json.replacer);
                    }
            };

            // end of content from JSFiddle
            // ---------------------------------------------------------------------------------- //

            // set default values -------------------------
            var SERVER_URL = 'http://localhost:8888';
            var requestUrl = SERVER_URL;  // updated by updateRequestUrl()
            var requestMethod = '';
            var urlDirectory = null;
            var headerPerPage = '0';
            var headerPage = '1';
            var headerIncludeResources = true;
            var headerSort = '';
            var headerNoXref = false;
            var headerFields = '';
            var requestBody = '';

            // fetch things -------------------------------
            // input controls
            var btnSubmit = $('#btn-submit');
            var inputAction = $('#input-action');
            var inputType = $('#input-type');
            var inputId = $('#input-id');
            var inputRequestUrl = $('#input-request-url');
            var inputPerPage = $('#input-per-page');
            var inputPage = $('#input-page');
            var inputIncludeResources = $('#input-include-resources');
            var inputSort = $('#input-sort');
            var inputNoXref = $('#input-no-xref');
            var inputFields = $('#input-fields');
            // var inputSearchHelp = $('#input-search-help');
            var inputRequestBody = $('#input-request-body');

            // "submitted" displays
            var displayRequestUrl = $('#display-server-url');
            var displayPerPage = $('#display-per-page');
            var displayPage = $('#display-page');
            var displayIncludeResources = $('#display-include-resources');
            var displaySort = $('#display-sort');
            var displayNoXref = $('#display-no-xref');
            var displayFields = $('#display-fields');
            // var displaySearchHelp = $('#display-search-help');
            var displayRequestBody = $('#display-request-body');

            // response headers
            var responseStatus = $('#response-status');
            var responseServer = $('#response-server');
            var responseCantusVersion = $('#response-cantus-version');
            var responsePerPage = $('#response-per-page');
            var responsePage = $('#response-page');
            var responseIncludeResources = $('#response-include-resources');
            var responseSort = $('#response-sort');
            var responseNoXref = $('#response-no-xref');
            var responseFields = $('#response-fields');
            var responseTotalResults = $('#response-total-results');
            // var responseSearchHelp = $('#response-search-help');

            // attach things to controls
            btnSubmit.click(runThing);
            inputAction.change(updateRequestUrl);
            inputType.change(updateRequestUrl);

            function setControlsToDefaults() {
                // Call this when the page is loaded. It sets all the request input controls to the
                // values stored in their variables.
                inputPerPage.val(headerPerPage);
                inputPage.val(headerPage);
                inputIncludeResources.prop('checked', headerIncludeResources);
                inputSort.val(headerSort);
                inputNoXref.prop('checked', headerNoXref);
                inputFields.val(headerFields);
                updateRequestUrl();
            }

            function updateRequestUrl(arg) {
                // Call this when you want to update the request URL (because the action or resource
                // type was changed).
                if (null == urlDirectory && (typeof arg == 'undefined')) {
                    $.ajax({url: SERVER_URL, dataType: 'json', success: updateRequestUrl});
                }
                else {
                    if (typeof arg != 'undefined' && arg.resources) {
                        // there is usually an argument, so we have to make sure it has "resources",
                        // which means we're the callback from the AJAX request just above
                        urlDirectory = arg;
                    }
                    var action = inputAction.val();
                    if ('search' == action)
                        action = 'browse';
                    var specificPath = urlDirectory['resources'][action][inputType.val()]
                    requestUrl = SERVER_URL + specificPath;
                    inputRequestUrl.html(requestUrl);
                    // also update the "ID" input box
                    if ('view' == action)
                        inputId.attr('disabled', false);
                    else
                        inputId.attr('disabled', true);
                }
            }

            function updateSubmissionDisplays() {
                // Call this after you updated the request variables but before submitting. It sets
                // the "display" things for the previously-submitted request.
                displayRequestUrl.html(requestMethod + ' ' + requestUrl);

                if ('0' == headerPerPage)
                    displayPerPage.html('N/A');
                else
                    displayPerPage.html(headerPerPage);

                if ('0' == headerPage || '1' == headerPage)
                    displayPage.html('N/A');
                else
                    displayPage.html(headerPage);

                if (headerIncludeResources)
                    displayIncludeResources.html('N/A');
                else
                    displayIncludeResources.html('false');

                if ('' == headerSort)
                    displaySort.html('N/A');
                else
                    displaySort.html(headerSort);

                if (headerNoXref)
                    displayNoXref.html('true');
                else
                    displayNoXref.html('N/A');

                if ('' == headerFields)
                    displayFields.html('N/A');
                else
                    displayFields.html(headerFields);

                try {
                    displayRequestBody.html(library.json.prettyPrint(JSON.parse(requestBody)));
                } catch (possibleError) {
                    if ('SyntaxError' == possibleError.name) {
                        // if it doesn't parse to JSON, just send it as a string
                        displayRequestBody.html(requestBody);
                    } else {
                        throw possibleError;
                    }
                }
            }

            function updateOutput(data) {
                // Call this with the response body.
                $('#output').html(library.json.prettyPrint(data));
            }

            function updateOutputFail(data) {
                // Call this with the response body when the request fails.
                $('#output').html('error');
            }

            function writeResponseHeaders(jqxhr, textStatus) {
                // This should be the "complete" callback for an AJAX request to the server. The
                // function updates the displayed response headers.
                responseStatus.html(jqxhr.status + ' ' + jqxhr.statusText);
                responseServer.html(jqxhr.getResponseHeader('Server'));
                responseCantusVersion.html(jqxhr.getResponseHeader('X-Cantus-Version'));
                responsePerPage.html(jqxhr.getResponseHeader('X-Cantus-Per-Page'));
                responsePage.html(jqxhr.getResponseHeader('X-Cantus-Page'));
                responseIncludeResources.html(jqxhr.getResponseHeader('X-Cantus-Include-Resources'));
                responseSort.html(jqxhr.getResponseHeader('X-Cantus-Sort'));
                responseNoXref.html(jqxhr.getResponseHeader('X-Cantus-No-Xref'));
                responseFields.html(jqxhr.getResponseHeader('X-Cantus-Fields'));
                responseTotalResults.html(jqxhr.getResponseHeader('X-Cantus-Total-Results'));
            }

            function runThing() {
                // update values from controls
                headerPerPage = inputPerPage.val();
                headerPage = inputPage.val();
                headerIncludeResources = inputIncludeResources.is(':checked');
                headerSort = inputSort.val();
                headerNoXref = inputNoXref.is(':checked');
                headerFields = inputFields.val();
                requestBody = inputRequestBody.val();

                // maybe we have to substitute an "id?"?
                if ('view' == inputAction.val()) {
                    requestUrl = requestUrl.replace('id?', inputId.val() + '/');
                    console.log(requestUrl);
                }

                // maybe we're submitted a "SEARCH" request?
                if ('search' == inputAction.val())
                    requestMethod = 'SEARCH';
                else
                    requestMethod = 'GET';

                // show the values we're about to submit
                updateSubmissionDisplays();

                // prepare the headers object
                var headers = {};
                if (headerPerPage != '0')
                    headers['X-Cantus-Per-Page'] = headerPerPage;

                if (headerPage != '0' && headerPage != '1')
                    headers['X-Cantus-Page'] = headerPage;

                if (!headerIncludeResources)
                    headers['X-Cantus-Include-Resources'] = 'false';

                if ('' != headerSort)
                    headers['X-Cantus-Sort'] = headerSort;

                if (headerNoXref)
                    headers['X-Cantus-No-Xref'] = 'true';

                if ('' != headerFields)
                    headers['X-Cantus-Fields'] = headerFields;

                // prepare the request settings
                var requestSettings = {url: requestUrl,
                                       success: updateOutput,
                                       error: updateOutputFail,
                                       complete: writeResponseHeaders,
                                       dataType: 'json',
                                       headers: headers,
                                       method: requestMethod,
                                      };
                if (requestBody.length > 0) {
                    requestSettings['data'] = requestBody;
                    requestSettings['processData'] = false;
                }

                // send the request
                $.ajax(requestSettings);
            }

            window.onload = function() { $(document).ready(setControlsToDefaults); };
        </script>
    </body>
</html>
